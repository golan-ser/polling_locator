<script>
    document.getElementById("locationButton").addEventListener("click", getLocation);

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
            alert("המכשיר שלך לא תומך בשירותי מיקום");
        }
    }

    function showPosition(position) {
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;

        // טעינת הנתונים מה-JSON
        fetch('polling_stations.json')
            .then(response => response.json())
            .then(data => {
                let closestStation = null;
                let minDistance = Infinity;

                data.forEach(station => {
                    const stationLat = station.lat;
                    const stationLon = station.lon;
                    const distance = getDistance(userLat, userLon, stationLat, stationLon);

                    if (distance < minDistance) {
                        minDistance = distance;
                        closestStation = station;
                    }
                });

                if (closestStation) {
                    const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${closestStation.lat},${closestStation.lon}`;
                    const wazeUrl = `https://waze.com/ul?ll=${closestStation.lat},${closestStation.lon}&navigate=yes`;

                    document.getElementById("result").innerHTML = `
                        <p>📍 הקלפי הקרובה ביותר: <strong>${closestStation.name}, ${closestStation.address}</strong></p>
                        <table class="table table-dark table-striped">
                            <tr><th>שם קלפי</th><td>${closestStation.name}</td></tr>
                            <tr><th>כתובת</th><td>${closestStation.address}</td></tr>
                        </table>
                        <a href="${googleMapsUrl}" target="_blank" class="btn btn-success">🔗 פתח ב-Google Maps</a>
                        <a href="${wazeUrl}" target="_blank" class="btn btn-primary">🔗 פתח ב-Waze</a>
                    `;
                } else {
                    document.getElementById("result").innerHTML = "❌ לא נמצאה קלפי קרובה.";
                }
            })
            .catch(error => {
                console.error("שגיאה בטעינת נתוני הקלפיות:", error);
                document.getElementById("result").innerHTML = "❌ שגיאה בטעינת נתוני הקלפיות.";
            });
    }

    function showError(error) {
        let message = "";
        switch (error.code) {
            case error.PERMISSION_DENIED:
                message = "יש לאפשר גישה למיקום כדי למצוא את הקלפי הקרובה.";
                break;
            case error.POSITION_UNAVAILABLE:
                message = "לא ניתן לאתר את המיקום שלך.";
                break;
            case error.TIMEOUT:
                message = "זמן הבקשה לאיתור מיקום נגמר.";
                break;
            case error.UNKNOWN_ERROR:
                message = "שגיאה בלתי ידועה.";
                break;
        }
        alert(message);
    }

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // רדיוס כדור הארץ בק"מ
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c; // התוצאה בקילומטרים
    }
</script>
